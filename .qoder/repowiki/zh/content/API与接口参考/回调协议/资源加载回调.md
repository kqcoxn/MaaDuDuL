# 资源加载回调

<cite>
**本文档中引用的文件**  
- [2.3-回调协议.md](file://instructions/maafw-guide/2.3-回调协议.md)
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md)
- [check_resource.py](file://check_resource.py)
- [demo1.py](file://deps/sample/python/demo1.py)
- [default_pipeline.json](file://assets/resource/base/default_pipeline.json)
- [configure.py](file://tools/configure.py)
- [install.py](file://tools/install.py)
</cite>

## 目录
1. [简介](#简介)
2. [资源加载回调类型](#资源加载回调类型)
3. [handle参数上下文意义](#handle参数上下文意义)
4. [回调数据字段详解](#回调数据字段详解)
5. [JSON结构示例](#json结构示例)
6. [实际应用场景](#实际应用场景)
7. [错误排查建议](#错误排查建议)
8. [总结](#总结)

## 简介
MaaFramework 通过 `MaaEventCallback` 回调机制向高层应用发送资源加载状态通知。资源加载相关的回调消息主要包括 `Resource.Loading.Starting`、`Resource.Loading.Succeeded` 和 `Resource.Loading.Failed` 三种类型，用于监控资源加载的全过程。这些回调提供了丰富的上下文信息，包括资源句柄、路径、类型和哈希值等，便于开发者实现进度监控、完整性验证和错误处理。

**Section sources**
- [2.3-回调协议.md](file://instructions/maafw-guide/2.3-回调协议.md#L3-L18)

## 资源加载回调类型
资源加载过程中的三种主要回调类型及其触发时机如下：

- **Resource.Loading.Starting**：当资源开始加载时触发，表示加载流程已启动。
- **Resource.Loading.Succeeded**：当资源成功加载完成时触发，表示资源已准备就绪。
- **Resource.Loading.Failed**：当资源加载失败时触发，用于通知加载异常。

这三种回调共享相同的 `details_json` 数据结构，便于统一处理。

**Section sources**
- [2.3-回调协议.md](file://instructions/maafw-guide/2.3-回调协议.md#L26-L56)

## handle参数上下文意义
在资源加载回调中，`handle` 参数为 `MaaResource*` 类型的句柄，代表当前操作的资源对象实例。该句柄是资源管理的核心标识，用于：

- 区分不同的资源实例
- 在回调中关联具体的资源操作上下文
- 作为后续资源操作（如查询、清理）的输入参数

通过该句柄，开发者可以对特定资源进行精确控制和状态查询。

**Section sources**
- [2.3-回调协议.md](file://instructions/maafw-guide/2.3-回调协议.md#L11-L13)

## 回调数据字段详解
资源加载回调的 `details_json` 包含以下关键字段：

- **res_id**：资源ID，唯一标识本次加载操作的数字编号。
- **path**：资源路径，表示待加载资源在文件系统中的位置。
- **type**：加载类型，指示资源的类别，包括：
  - `"Bundle"`：完整资源目录（通过 `post_bundle` 加载）
  - `"OcrModel"`：OCR模型目录（通过 `post_ocr_model` 加载）
  - `"Pipeline"`：流水线配置目录或单个json/jsonc文件（通过 `post_pipeline` 加载）
  - `"Image"`：图片目录或单个图片文件（通过 `post_image` 加载）
- **hash**：资源哈希值，用于验证资源完整性和唯一性。

这些字段共同构成了资源加载的完整上下文信息。

**Section sources**
- [2.3-回调协议.md](file://instructions/maafw-guide/2.3-回调协议.md#L34-L48)

## JSON结构示例
资源加载回调的 `details_json` 结构示例如下：

```json
{
    "res_id": 100000001,
    "path": "D:/_Projects/programs/MaaDuDuL/assets/resource/base",
    "type": "Bundle",
    "hash": "ae736802809888da"
}
```

此结构在 `Resource.Loading.Starting`、`Resource.Loading.Succeeded` 和 `Resource.Loading.Failed` 三种回调中保持一致，仅内容值可能不同。

**Section sources**
- [2.3-回调协议.md](file://instructions/maafw-guide/2.3-回调协议.md#L33-L38)

## 实际应用场景
### 监控资源加载进度
通过监听 `Resource.Loading.Starting` 和 `Resource.Loading.Succeeded` 回调，可以实现资源加载进度的可视化监控。例如，在UI中显示当前加载的资源路径和状态。

### 验证资源完整性
利用 `hash` 字段，在 `Resource.Loading.Succeeded` 回调中验证资源哈希值，确保加载的资源未被篡改或损坏。

### 处理加载失败情况
在 `Resource.Loading.Failed` 回调中，结合 `path` 和 `type` 字段进行错误诊断，如路径不存在、权限不足等问题，并提供相应的恢复策略。

**Section sources**
- [check_resource.py](file://check_resource.py#L10-L23)
- [demo1.py](file://deps/sample/python/demo1.py#L77-L80)

## 错误排查建议
### 路径错误
- 检查 `path` 字段是否指向有效的文件系统路径
- 确认路径中的目录分隔符符合操作系统规范
- 验证路径是否存在且可读

### 哈希校验失败
- 检查资源文件是否完整下载
- 验证哈希算法的一致性
- 确认资源文件未被意外修改

### 其他常见问题
- 确保资源目录结构符合规范（如 `default_pipeline.json` 存在）
- 检查文件权限设置
- 验证资源文件格式正确性

**Section sources**
- [configure.py](file://tools/configure.py#L8-L22)
- [install.py](file://tools/install.py#L50-L59)

## 总结
资源加载回调是MaaFramework中重要的状态通知机制，通过 `Resource.Loading.Starting`、`Resource.Loading.Succeeded` 和 `Resource.Loading.Failed` 三种类型，配合 `handle` 句柄和详细的 `details_json` 数据，为开发者提供了全面的资源加载监控能力。合理利用这些回调，可以有效提升应用的稳定性和用户体验。