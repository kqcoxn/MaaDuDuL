# 节点识别回调

<cite>
**本文档引用文件**  
- [2.3-回调协议.md](file://instructions/maafw-guide/2.3-回调协议.md)
- [reco_helper.py](file://agent/customs/maahelper/reco_helper.py)
- [logic_enhance.py](file://agent/customs/global_func/logic_enhance.py)
- [tasker.py](file://agent/customs/maahelper/tasker.py)
- [prompter.py](file://agent/customs/utils/prompter.py)
- [counter.py](file://agent/customs/utils/counter.py)
- [1.1-快速开始.md](file://instructions/maafw-guide/1.1-快速开始.md)
</cite>

## 目录
1. [节点识别回调机制](#节点识别回调机制)
2. [reco_id与task_id、name、focus字段的关联关系](#reco_id与task_idnamefocus字段的关联关系)
3. [实际应用场景](#实际应用场景)
4. [常见问题与解决方案](#常见问题与解决方案)
5. [性能优化建议](#性能优化建议)

## 节点识别回调机制

节点识别回调机制是MaaFramework中用于通知识别过程状态的核心功能。该机制通过`MaaEventCallback`回调函数发送各种状态通知，所有回调消息均采用统一格式：消息类型（message）+ 详细数据（details_json）。

在节点识别过程中，系统会发送三种主要的回调消息：

- **Node.Recognition.Starting**：当节点开始识别时发送，表示识别流程已启动。
- **Node.Recognition.Succeeded**：当节点识别成功时发送，包含识别结果的详细信息。
- **Node.Recognition.Failed**：当节点识别失败时发送，用于通知识别未成功。

这些回调消息仅在通过`post_task`或`run_task`执行完整流水线任务时发送。对于仅执行识别任务的情况，系统会发送`Node.RecognitionNode.Starting`、`Node.RecognitionNode.Succeeded`和`Node.RecognitionNode.Failed`等专门的识别节点消息。

回调函数的原型定义如下：
```cpp
typedef void(MAA_CALL* MaaEventCallback)(void* handle, const char* message, const char* details_json, void* trans_arg);
```

其中，`details_json`参数始终为有效的JSON字符串，建议使用成熟的JSON库进行解析。

**Section sources**
- [2.3-回调协议.md](file://instructions/maafw-guide/2.3-回调协议.md#L176-L303)

## reco_id与task_id、name、focus字段的关联关系

在节点识别回调中，`reco_id`、`task_id`、`name`和`focus`字段共同构成了识别流程的上下文信息，它们在识别过程中具有重要的意义。

### reco_id与task_id

`reco_id`（识别ID）和`task_id`（任务ID）是两个关键的标识符。`task_id`标识了整个任务的执行实例，而`reco_id`则专门用于标识识别操作。这两个ID的关联关系如下：

- `task_id`在整个任务执行过程中保持不变，用于追踪任务的完整生命周期。
- `reco_id`在每次识别操作时生成，用于区分不同的识别请求。
- 通过`MaaTaskerGetNodeDetail`接口可以获取节点信息，其中包含`reco_id`和`action_id`的对应关系。

### name字段

`name`字段表示节点的名称，是识别流程中的重要标识。它在系统中的作用包括：

- 作为识别目标的标识符，用于确定需要识别的UI元素或游戏对象。
- 在回调消息中提供上下文信息，帮助调用方理解当前识别的是哪个节点。
- 在自定义识别器中作为参数传递，用于指定识别目标。

### focus字段

`focus`字段是任意类型的焦点相关数据，用于传递与当前识别上下文相关的附加信息。它的主要用途包括：

- 传递识别区域的坐标或边界框信息。
- 携带与识别目标相关的元数据。
- 在复杂识别流程中传递中间状态信息。

这些字段共同构成了识别流程的完整上下文，使得回调机制能够提供丰富的状态信息。

**Section sources**
- [2.3-回调协议.md](file://instructions/maafw-guide/2.3-回调协议.md#L184-L198)
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L619-L626)

## 实际应用场景

节点识别回调机制在实际应用中有多种用途，以下是一些典型的应用场景。

### 获取识别耗时

通过监听`Node.Recognition.Starting`和`Node.Recognition.Succeeded`（或`Failed`）消息，可以计算识别操作的耗时。具体实现方式如下：

1. 在收到`Node.Recognition.Starting`消息时记录开始时间。
2. 在收到`Node.Recognition.Succeeded`或`Node.Recognition.Failed`消息时记录结束时间。
3. 计算时间差，得到识别耗时。

这种时间测量对于性能分析和优化非常有价值，可以帮助识别耗时较长的识别操作。

### 分析识别成功率

通过统计`Node.Recognition.Succeeded`和`Node.Recognition.Failed`消息的数量，可以计算识别成功率。具体步骤包括：

1. 初始化成功和失败计数器。
2. 在收到`Node.Recognition.Succeeded`消息时增加成功计数。
3. 在收到`Node.Recognition.Failed`消息时增加失败计数。
4. 定期计算并报告识别成功率。

这种分析有助于评估识别算法的稳定性和可靠性，为优化提供数据支持。

### 可视化识别区域

通过启用`save_draw`调试选项，可以保存图像识别的可视化结果。这些可视化结果包括：

- 识别到的目标区域用矩形框标出。
- 识别结果的置信度分数显示。
- OCR识别的文字内容标注。

这些可视化结果对于调试和优化识别算法非常有帮助，可以直观地看到识别效果。

**Section sources**
- [1.1-快速开始.md](file://instructions/maafw-guide/1.1-快速开始.md#L195-L200)
- [2.3-回调协议.md](file://instructions/maafw-guide/2.3-回调协议.md#L180-L303)

## 常见问题与解决方案

在使用节点识别回调机制时，可能会遇到一些常见问题。以下是这些问题的解决方案。

### 识别超时

识别超时是指识别操作在预定时间内未能完成。解决方案包括：

- **增加超时阈值**：根据实际场景调整识别超时时间。
- **优化识别算法**：改进识别算法以提高识别速度。
- **使用稳定识别器**：如`StableReco`类所示，通过多次连续识别确保结果稳定性，避免因偶然因素导致的误识别。

在`logic_enhance.py`中实现的`StableReco`类就是一个典型的稳定识别器示例，它通过计数器机制确保只有当连续识别次数达到阈值时才返回识别结果。

### 误识别

误识别是指系统错误地将非目标对象识别为目标。解决方案包括：

- **提高识别阈值**：增加识别的置信度要求。
- **优化识别区域**：精确设置识别区域（ROI），减少干扰。
- **使用多特征识别**：结合多种识别特征（如模板匹配、OCR等）提高准确性。

在`reco_helper.py`中，`filter_reco`方法可以根据可信度过滤识别结果，`sort_reco`方法可以按可信度对结果排序，这些都是减少误识别的有效手段。

### 回调处理异常

回调函数可能在不同线程中被调用，需要注意线程安全。建议在回调函数中添加异常处理，防止回调函数异常影响框架运行。

**Section sources**
- [logic_enhance.py](file://agent/customs/global_func/logic_enhance.py#L18-L95)
- [reco_helper.py](file://agent/customs/maahelper/reco_helper.py#L207-L231)
- [2.3-回调协议.md](file://instructions/maafw-guide/2.3-回调协议.md#L360-L364)

## 性能优化建议

为了确保节点识别回调机制的高效运行，以下是一些性能优化建议。

### 轻量级回调处理

回调函数应尽快返回，避免阻塞框架的执行流程。具体建议包括：

- **避免复杂计算**：在回调函数中避免执行耗时的计算或I/O操作。
- **异步处理**：将复杂的处理逻辑放到单独的线程或任务中异步执行。
- **批量处理**：如果需要处理大量回调消息，可以考虑批量处理以减少开销。

### 线程安全

由于回调函数可能在不同线程中被调用，需要注意线程安全。建议使用线程安全的数据结构和同步机制来保护共享资源。

### 错误处理

在回调函数中添加异常处理，防止回调函数异常影响框架运行。可以使用`try-catch`块包裹回调处理逻辑，并记录错误日志。

### 资源管理

合理管理回调中使用的资源，避免内存泄漏。例如，在`counter.py`中实现的`CounterManager`类提供了计数器的集中管理，支持创建、获取、删除和清空计数器的功能。

**Section sources**
- [2.3-回调协议.md](file://instructions/maafw-guide/2.3-回调协议.md#L363-L364)
- [counter.py](file://agent/customs/utils/counter.py#L75-L141)
- [prompter.py](file://agent/customs/utils/prompter.py#L34-L54)