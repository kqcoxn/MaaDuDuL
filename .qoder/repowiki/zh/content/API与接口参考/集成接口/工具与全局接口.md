# 工具与全局接口

<cite>
**本文档引用的文件**   
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md)
- [interface.json](file://assets/interface.json)
- [MaaDuDuL.py](file://launcher/MaaDuDuL.py)
- [setup.py](file://agent/preprocess/setup.py)
- [ci/maa_option.json](file://ci/config/maa_option.json)
</cite>

## 目录
1. [简介](#简介)
2. [全局接口](#全局接口)
3. [MaaToolkit工具集](#MaaToolkit工具集)
4. [Python调用示例](#Python调用示例)
5. [配置项详解](#配置项详解)
6. [最佳实践](#最佳实践)

## 简介

本文档详细介绍了MaaUtility和MaaToolkit模块的基础功能，重点涵盖MaaVersion、MaaGlobalSetOption等全局接口的调用方式与配置项含义。文档还详细描述了插件加载（MaaGlobalLoadPlugin）和工具集（MaaToolkit）的功能，包括设备发现（AdbDeviceFind）、配置初始化等实用方法。

MaaFramework是一个强大的自动化框架，通过MaaUtility和MaaToolkit模块提供了一系列全局接口和工具函数，用于版本查询、全局配置设置、插件加载和设备枚举等功能。这些接口为开发者提供了灵活的控制能力，可以方便地集成到各种应用场景中。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L1-L21)

## 全局接口

### MaaVersion

MaaVersion接口用于返回MaaFramework的版本信息。这是一个基础的全局接口，用于确认当前使用的框架版本。

在Python中，可以通过Library.version()方法调用此接口，返回框架的版本字符串。这个接口对于版本管理和兼容性检查非常重要，可以帮助开发者确认当前环境使用的MaaFramework版本是否符合要求。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L19-L21)

### MaaGlobalSetOption

MaaGlobalSetOption接口用于设置全局配置选项，这些配置会影响整个MaaFramework的运行行为。在Python绑定中，这些配置会被拆分为具体的配置属性。

#### 配置项说明

- **LogDir**：设置日志文件的存储路径。所有日志信息将被保存到指定目录中。

- **SaveDraw**：设置是否将识别结果保存到"日志路径/vision"目录中。开启后，RecoDetail将可以获取到可视化绘制结果。

- **StdoutLevel**：设置日志输出到控制台的级别，控制哪些级别的日志信息会显示在控制台。

- **DebugMode**：设置是否启用调试模式。在调试模式下，RecoDetail将可以获取到原始图像和绘制结果；所有任务都会被视为焦点任务而产生回调。

- **SaveOnError**：设置是否在发生错误时保存截图到"日志路径/on_error"目录中，便于问题排查。

- **DrawQuality**：设置识别可视化图像的JPEG质量（0-100），默认值为85。较高的质量值会产生更清晰但更大的文件。

- **RecoImageCacheLimit**：设置识别图像缓存数量限制，默认值为4096。这个限制控制了内存中缓存的图像数量。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L23-L53)
- [ci/maa_option.json](file://ci/config/maa_option.json#L1-L10)

### MaaGlobalLoadPlugin

MaaGlobalLoadPlugin接口用于加载插件库。该接口接受插件库路径或名称作为参数。

插件可以使用完整路径指定，也可以仅使用名称。当仅使用名称时，系统会在系统目录和当前目录中搜索插件。此外，还支持递归搜索目录中的插件，这为插件管理提供了很大的灵活性。

插件机制允许扩展MaaFramework的功能，通过加载不同的插件可以实现特定的功能需求，如自定义识别算法、特殊控制方式等。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L55-L59)

## MaaToolkit工具集

MaaToolkit提供了一系列实用的工具函数，主要用于设备发现、配置初始化等操作。

### ADB设备管理

MaaToolkit提供了完整的ADB设备管理功能：

- **MaaToolkitAdbDeviceFind**：搜索所有已知的安卓模拟器设备，并将结果写入输出缓冲区。

- **MaaToolkitAdbDeviceFindSpecified**：根据指定的ADB路径搜索模拟器设备。

- **MaaToolkitAdbDeviceListSize**：获取设备列表的大小。

- **MaaToolkitAdbDeviceListAt**：获取设备列表中指定索引的设备。

- **MaaToolkitAdbDeviceGetName**：获取设备的名称。

- **MaaToolkitAdbDeviceGetAdbPath**：获取设备的ADB路径。

- **MaaToolkitAdbDeviceGetAddress**：获取设备的连接地址。

- **MaaToolkitAdbDeviceGetScreencapMethods**：获取设备支持的截图方式。

- **MaaToolkitAdbDeviceGetInputMethods**：获取设备支持的输入方式。

- **MaaToolkitAdbDeviceGetConfig**：获取设备的配置信息。

这些接口为自动化脚本提供了完整的设备发现和管理能力，可以方便地枚举和选择目标设备。

### 桌面窗口管理

MaaToolkit还提供了桌面窗口管理功能：

- **MaaToolkitDesktopWindowFindAll**：查询所有窗口信息，并将结果写入输出缓冲区。

- **MaaToolkitDesktopWindowListSize**：获取窗口列表的大小。

- **MaaToolkitDesktopWindowListAt**：获取窗口列表中指定索引的窗口。

- **MaaToolkitDesktopWindowGetHandle**：获取窗口的句柄。

- **MaaToolkitDesktopWindowGetClassName**：获取窗口的类名。

- **MaaToolkitDesktopWindowGetWindowName**：获取窗口的名称。

这些接口对于基于窗口的应用程序自动化非常有用，可以精确地定位和控制目标窗口。

### 配置初始化

- **MaaToolkitConfigInitOption**：从指定的用户路径中加载全局配置，支持默认配置的设置。

这个接口用于初始化MaaToolkit的配置，确保工具集能够正确地读取和应用用户设置。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L743-L892)

## Python调用示例

以下是一些Python调用示例，展示了如何使用MaaUtility和MaaToolkit模块的功能。

### 版本查询

```python
from maa.library import Library

# 获取MaaFramework版本
version = Library.version()
print(f"MaaFramework版本: {version}")
```

### 全局选项设置

```python
import json
import os

# 创建配置目录
config_dir = "./config/mddl"
os.makedirs(config_dir, exist_ok=True)

# 设置全局选项
config = {
    "enable_pip_install": True,
    "last_version": "v0.1.2",
    "mirrors": [
        "https://pypi.tuna.tsinghua.edu.cn/simple",
        "https://mirrors.ustc.edu.cn/pypi/simple",
        "https://mirrors.aliyun.com/pypi/simple",
    ],
}

# 保存配置
with open("./config/mddl/pip_config.json", "w", encoding="utf-8") as f:
    json.dump(config, f, indent=4, ensure_ascii=False)
```

### 插件加载

```python
# 在Python中，插件加载通常通过配置文件或环境变量完成
# 实际的MaaGlobalLoadPlugin调用在底层库中处理
```

### 模拟器设备枚举

```python
# 设备枚举功能在MaaToolkit中实现
# 通过MaaToolkitAdbDeviceFind等接口完成
```

### 依赖环境安装

```python
def _install_requirements(req_file=None, mirrors=None):
    """安装requirements.txt中列出的依赖包。"""
    req_path = Path(req_file) if req_file else Path("requirements.txt")
    if not req_path.exists():
        return False

    # 获取正确的Python可执行文件
    python_exe = _get_python_executable()

    # 准备镜像源列表
    mirror_list = []
    if mirrors:
        if isinstance(mirrors, list):
            mirror_list.extend(mirrors)
        else:
            mirror_list.append(mirrors)
    
    # 添加默认源作为兜底
    mirror_list.append(None)

    # 逐个尝试镜像源
    for idx, mirror in enumerate(mirror_list):
        try:
            cmd = [
                python_exe,
                "-m",
                "pip",
                "install",
                "-r",
                str(req_path),
                "--no-warn-script-location",
            ]

            if mirror:
                cmd.extend(["-i", mirror])

            subprocess.check_call(
                cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL
            )
            print("环境更新成功！")
            return True
        except Exception as e:
            if idx < len(mirror_list) - 1:
                print("当前镜像源失败，尝试下一个...")
                continue
            else:
                print("环境加载失败，请检查网络与环境后重新尝试！")
                return False

    return False
```

**Section sources**
- [setup.py](file://agent/preprocess/setup.py#L135-L200)
- [MaaDuDuL.py](file://launcher/MaaDuDuL.py#L1-L22)

## 配置项详解

### 日志管理

日志管理相关的配置项对调试和问题排查至关重要：

- **LogDir**：指定日志文件的存储位置，建议设置为有足够空间的目录。

- **SaveDraw**：控制是否保存识别过程的可视化结果，开启后会占用更多磁盘空间。

- **StdoutLevel**：控制台日志级别，可以根据需要调整详细程度。

- **SaveOnError**：错误时自动保存截图，对于问题复现和分析非常有帮助。

- **DrawQuality**：可视化图像质量，平衡文件大小和图像清晰度。

### 性能监控

- **RecoImageCacheLimit**：识别图像缓存限制，影响内存使用和识别性能。较大的缓存可以提高重复识别的效率，但会占用更多内存。

### 调试辅助

- **DebugMode**：调试模式开关，开启后提供更详细的调试信息，但可能影响性能。

这些配置项的合理设置可以显著影响系统的运行效率和稳定性。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L27-L53)
- [ci/maa_option.json](file://ci/config/maa_option.json#L1-L10)

## 最佳实践

### 生产环境配置

在生产环境中，建议遵循以下最佳实践：

- **关闭调试模式**：生产环境中应关闭DebugMode，以减少不必要的性能开销和日志输出。

- **合理设置缓存限制**：根据系统内存情况合理设置RecoImageCacheLimit，避免内存溢出。

- **定期清理日志**：设置日志轮转策略，避免日志文件无限增长占用磁盘空间。

- **使用稳定的镜像源**：在安装依赖时，优先使用稳定可靠的镜像源，确保安装过程的可靠性。

### 开发环境配置

在开发环境中，建议：

- **开启调试模式**：便于问题排查和功能验证。

- **启用详细日志**：设置较高的StdoutLevel，获取更详细的运行信息。

- **保存错误截图**：开启SaveOnError，便于分析失败原因。

- **调整图像质量**：根据需要调整DrawQuality，平衡调试效果和存储空间。

### 配置管理

- **配置文件化**：将配置项保存在配置文件中，便于管理和版本控制。

- **环境分离**：为开发、测试和生产环境维护不同的配置。

- **默认值设置**：为所有配置项设置合理的默认值，确保系统在缺少配置时仍能正常运行。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L23-L53)
- [ci/maa_option.json](file://ci/config/maa_option.json#L1-L10)
- [setup.py](file://agent/preprocess/setup.py#L80-L109)