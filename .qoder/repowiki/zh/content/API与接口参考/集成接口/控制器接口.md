# 控制器接口

<cite>
**本文档引用的文件**  
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md)
- [2.4-控制方式说明.md](file://instructions/maafw-guide/2.4-控制方式说明.md)
- [tasker.py](file://agent/customs/maahelper/tasker.py)
- [reco_helper.py](file://agent/customs/maahelper/reco_helper.py)
</cite>

## 目录
1. [控制器创建方法](#控制器创建方法)  
2. [异步控制指令与操作ID管理](#异步控制指令与操作id管理)  
3. [Python调用示例](#python调用示例)  
4. [高级功能实现](#高级功能实现)  
5. [控制器特性差异与平台适配](#控制器特性差异与平台适配)  
6. [连接状态监控与错误恢复](#连接状态监控与错误恢复)  
7. [性能优化建议](#性能优化建议)

## 控制器创建方法

### MaaAdbControllerCreate

用于创建基于ADB协议的安卓设备控制器。该方法通过ADB工具与安卓设备或模拟器建立连接，实现设备控制。

**参数说明：**
- `adb_path`: ADB可执行文件的完整路径。
- `address`: 设备连接地址，格式为`host:port`，如`127.0.0.1:5555`。
- `screencap_methods`: 指定可用的截图方式，通过按位或组合。支持的方式包括`EncodeToFileAndPull`、`Encode`、`RawWithGzip`、`RawByNetcat`、`MinicapDirect`、`MinicapStream`和`EmulatorExtras`。框架会自动测速并选择最快且兼容的方式。
- `input_methods`: 指定可用的输入方式，通过按位或组合。支持`AdbShell`、`MinitouchAndAdbKey`、`Maatouch`和`EmulatorExtras`。框架按优先级顺序尝试，选择首个可用方式。
- `config`: 额外配置参数，可用于传递特定于设备的配置。
- `agent_path`: MaaAgentBinary的路径，用于增强控制能力。

此方法适用于安卓模拟器或已开启USB调试的安卓设备，是自动化安卓应用操作的标准方式。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#maaadbcontrollercreate)
- [2.4-控制方式说明.md](file://instructions/maafw-guide/2.4-控制方式说明.md#adb-screencap)

### MaaWin32ControllerCreate

用于创建基于Windows API的桌面应用程序控制器。该方法通过窗口句柄与Windows应用程序交互，实现对桌面应用的自动化控制。

**参数说明：**
- `hWnd`: 目标应用程序窗口的句柄（HWND）。
- `screencap_method`: 指定的截图方式。支持`GDI`、`FramePool`、`DXGI_DesktopDup`、`DXGI_DesktopDup_Window`、`PrintWindow`和`ScreenDC`。需根据目标应用的渲染方式选择最兼容的方案。
- `mouse_method`: 指定的鼠标输入方式。支持`Seize`、`SendMessage`、`PostMessage`、`LegacyEvent`、`PostThreadMessage`、`SendMessageWithCursorPos`和`PostMessageWithCursorPos`。
- `keyboard_method`: 指定的键盘输入方式，与鼠标方法相同。

此方法适用于Windows平台上的桌面应用，如游戏或原生应用程序，能够实现精确的输入模拟。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#maawin32controllercreate)
- [2.4-控制方式说明.md](file://instructions/maafw-guide/2.4-控制方式说明.md#win32-screencap)

### MaaCustomControllerCreate

用于创建自定义控制器。允许开发者通过实现自定义的回调结构体来集成非标准的控制协议或特殊硬件。

**参数说明：**
- `controller`: 一个包含自定义控制逻辑的回调结构体，需实现连接、截图、输入等基本操作。
- `controller_arg`: 传递给回调函数的自定义参数，可用于配置或状态传递。

此方法提供了最大的灵活性，适用于需要与私有协议、特殊设备或非主流平台集成的场景。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#maacustomcontrollercreate)

## 异步控制指令与操作ID管理

MaaFramework的所有控制指令均为异步操作，调用后立即返回一个操作ID，用于后续的状态查询和结果获取。

### 异步调用机制

所有`Post`前缀的方法（如`PostClick`、`PostSwipe`）都是异步的。调用后，框架会将操作加入队列并立即返回一个`操作ID`。用户需通过`MaaControllerStatus`查询操作状态，或通过`MaaControllerWait`阻塞等待操作完成。

```mermaid
flowchart TD
A[调用 PostClick(x, y)] --> B[返回操作ID]
B --> C{查询状态或等待}
C --> D[MaaControllerStatus]
C --> E[MaaControllerWait]
D --> F[获取操作结果]
E --> F
```

**Diagram sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#maacontrollerpostclick)

### 常用异步控制指令

#### PostClick
在指定坐标执行点击操作。
- **参数**: `x`, `y` (像素坐标)
- **适用控制器**: ADB, Win32, PlayCover

#### PostSwipe
执行从起点到终点的滑动操作。
- **参数**: `x1`, `y1` (起点), `x2`, `y2` (终点), `duration` (滑动时长，毫秒)
- **适用控制器**: ADB, Win32, PlayCover

#### PostScreencap
触发异步截图操作。
- **参数**: 无
- **返回**: 通过`MaaControllerCachedImage`获取截图数据
- **适用控制器**: 所有类型

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#maacontrollerpostclick)
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#maacontrollerpostswipe)
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#maacontrollerpostscreencap)

## Python调用示例

以下示例展示了如何使用Python绑定完成设备连接、输入事件模拟、截图获取和Shell命令执行等完整流程。

### 设备连接与初始化

```python
from maa.tasker import Tasker
from maa.controller import AdbController

# 创建ADB控制器
controller = AdbController(
    adb_path="path/to/adb.exe",
    address="127.0.0.1:5555",
    screencap_methods=1 | 2 | 4,  # Encode, RawWithGzip, Maatouch
    input_methods=2 | 4  # MinitouchAndAdbKey, Maatouch
)

# 创建任务执行器并绑定控制器
tasker = Tasker()
tasker.bind(controller)

# 异步连接设备
connection_op = tasker.controller.post_connection()
connection_op.wait()  # 等待连接完成

if tasker.controller.connected:
    print("设备连接成功")
else:
    print("设备连接失败")
```

### 输入事件模拟与截图获取

```python
# 执行截图
screenshot_op = tasker.controller.post_screencap()
screenshot_op.wait()
image_data = tasker.controller.cached_image

# 在坐标 (500, 300) 点击
click_op = tasker.controller.post_click(500, 300)
click_op.wait()

# 从 (100, 100) 滑动到 (800, 600)，持续500ms
swipe_op = tasker.controller.post_swipe(100, 100, 800, 600, 500)
swipe_op.wait()
```

### Shell命令执行

```python
# 执行ADB shell命令（仅ADB控制器支持）
shell_op = tasker.controller.post_shell("input keyevent 3")  # HOME键
shell_op.wait()
output = tasker.controller.get_shell_output()
print(f"命令输出: {output}")
```

**Section sources**
- [tasker.py](file://agent/customs/maahelper/tasker.py)
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md)

## 高级功能实现

### 多点触控

通过`PostTouchDown`、`PostTouchMove`和`PostTouchUp`系列方法实现多点触控。

```python
# 模拟双指捏合
# 第一根手指按下
tasker.controller.post_touch_down(contact=0, x=300, y=400).wait()
# 第二根手指按下
tasker.controller.post_touch_down(contact=1, x=700, y=400).wait()
# 第一根手指移动
tasker.controller.post_touch_move(contact=0, x=400, y=400).wait()
# 第二根手指移动
tasker.controller.post_touch_move(contact=1, x=600, y=400).wait()
# 抬起两根手指
tasker.controller.post_touch_up(contact=0).wait()
tasker.controller.post_touch_up(contact=1).wait()
```

### 键盘输入

使用`PostClickKey`、`PostKeyDown`和`PostKeyUp`模拟键盘输入。

```python
# 模拟按下并释放回车键
tasker.controller.post_key_down(key=13).wait()  # VK_RETURN
tasker.controller.post_key_up(key=13).wait()
```

### 应用启停

```python
# 启动应用（仅ADB控制器支持）
tasker.controller.post_start_app("com.example.app").wait()

# 关闭应用（仅ADB控制器支持）
tasker.controller.post_stop_app("com.example.app").wait()
```

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#maacontrollerposttouchdown)
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#maacontrollerpostclickkey)
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#maacontrollerpoststartapp)

## 控制器特性差异与平台适配

### PlayCover控制器限制

PlayCover控制器用于在macOS上控制通过PlayCover运行的iOS应用，存在以下限制：
- **仅支持单点触控**：`contact`参数必须为0。
- **不支持键盘输入**：`start_app`、`click_key`、`input_text`、`key_down`、`key_up`、`scroll`等操作均不支持。
- **特性标志**：`MaaControllerFeature_UseMouseDownAndUpInsteadOfClick`，表示框架会使用`touch_down` + `touch_up`代替`click`操作。

**Section sources**
- [2.4-控制方式说明.md](file://instructions/maafw-guide/2.4-控制方式说明.md#playcover-macos)

## 连接状态监控和错误恢复策略

### 连接状态监控

通过`MaaControllerConnected`方法实时检查设备连接状态。

```python
if not tasker.controller.connected:
    print("设备已断开连接，尝试重新连接...")
    # 执行重连逻辑
    tasker.controller.post_connection().wait()
```

### 错误恢复策略

建议在关键操作前后进行状态检查，并实现重试机制。

```python
def safe_click(x, y, max_retries=3):
    for attempt in range(max_retries):
        if not tasker.controller.connected:
            tasker.controller.post_connection().wait()
        
        op = tasker.controller.post_click(x, y)
        if op.wait(timeout=5000):  # 设置超时
            return True
        else:
            print(f"点击失败，重试 {attempt + 1}/{max_retries}")
    return False
```

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#maacontrollerconnected)

## 性能优化建议

### 截图尺寸优化

通过`MaaControllerSetOption`设置截图缩放，降低图像处理负载。

```python
# 将截图长边缩放至960像素
tasker.controller.set_option("ScreenshotTargetLongSide", 960)
```

### 输入延迟调整

根据设备性能调整输入指令的间隔，避免因指令过快导致设备处理不过来。

```python
import time
# 在连续操作间添加延迟
time.sleep(0.1)  # 100ms延迟
```

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#maacontrollersetoption)