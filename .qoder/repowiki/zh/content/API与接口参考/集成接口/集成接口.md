# 集成接口

<cite>
**本文档引用的文件**
- [interface.json](file://assets/interface.json)
- [2.1-集成文档.md](file://instructions/maafw-guide/2.1-集成文档.md)
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md)
- [tasker.py](file://agent/customs/maahelper/tasker.py)
- [local_storage.py](file://agent/customs/utils/local_storage.py)
- [setup.py](file://agent/preprocess/setup.py)
- [main.py](file://agent/main.py)
- [MaaDuDuL.py](file://launcher/MaaDuDuL.py)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [核心模块概述](#核心模块概述)
3. [MaaUtility 接口](#maautility-接口)
4. [MaaResource 接口](#maaresource-接口)
5. [MaaController 接口](#maacontroller-接口)
6. [MaaTasker 接口](#maatasker-接口)
7. [异步与同步操作模式](#异步与同步操作模式)
8. [Python 调用示例](#python-调用示例)
9. [关键流程接口调用序列](#关键流程接口调用序列)
10. [错误处理与异常解决方案](#错误处理与异常解决方案)
11. [性能优化建议](#性能优化建议)

## 简介

MaaDuDuL 是一款基于 MaaFramework 构建的自动化助手，专为《嘟嘟脸恶作剧》游戏设计。本集成接口文档旨在全面介绍 MaaDuDuL 对外暴露的所有集成接口，涵盖 MaaUtility、MaaResource、MaaController、MaaTasker 等核心模块的调用方式、参数定义及返回值格式。

文档详细阐述了异步操作（如 PostTask、PostConnection）与同步操作的区别及适用场景，并为每个核心接口提供 Python 调用示例。此外，文档还结合实际代码，解释了资源加载、控制器连接、任务执行等关键流程的接口调用序列，为开发者提供完整的集成指导。

**Section sources**
- [README.md](file://README.md#L1-L118)

## 核心模块概述

MaaDuDuL 的核心功能由 MaaFramework 提供，其架构主要由以下几个核心模块构成：

*   **MaaUtility**: 提供框架级别的工具函数，如获取版本号、设置全局选项等。
*   **MaaResource**: 负责管理任务流程（Pipeline）和资源文件的加载。它定义了自动化任务的逻辑和步骤。
*   **MaaController**: 作为与外部设备或应用程序交互的桥梁，负责执行点击、滑动、截图等控制操作。
*   **MaaTasker**: 作为任务调度和执行的核心，它将 MaaResource 和 MaaController 绑定在一起，负责启动和管理具体的自动化任务。

这些模块共同协作，实现了从资源加载、设备连接到任务执行的完整自动化流程。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L1-L21)

## MaaUtility 接口

MaaUtility 模块提供了一系列基础的工具函数，用于获取框架信息和配置全局行为。

### MaaVersion

此接口用于获取 MaaFramework 的版本号。

*   **C API**: `MaaVersion()`
*   **Python 接口**: `Library.version()`
*   **返回值**: 字符串形式的版本号。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L19-L21)

### MaaGlobalSetOption

此接口用于设置全局配置选项，这些选项会影响整个框架的行为。

*   **LogDir**: 设置日志文件的存储路径。
*   **SaveDraw**: 设置是否将识别过程中的可视化结果保存到 `日志路径/vision` 目录中。
*   **StdoutLevel**: 设置日志输出到标准输出（stdout）的级别。
*   **DebugMode**: 启用调试模式，启用后可以获取更详细的识别信息（raw/draws）。
*   **SaveOnError**: 设置是否在发生错误时自动保存截图。
*   **DrawQuality**: 设置识别可视化图像的 JPEG 质量（0-100）。
*   **RecoImageCacheLimit**: 设置识别图像缓存的数量上限。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L23-L55)

## MaaResource 接口

MaaResource 模块负责管理自动化任务的逻辑定义（即 Pipeline）和相关资源。

### MaaResourcePostBundle

此接口用于异步加载指定路径下的资源文件（通常是包含 Pipeline 定义的 JSON 文件）。

*   **参数**: `path` - 资源文件的路径。
*   **返回值**: 一个操作 ID，用于后续查询加载状态。
*   **状态查询**: 可通过 `MaaResourceStatus` 或 `MaaResourceWait` 查询加载操作的状态。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L128-L132)

### MaaResourceOverridePipeline

此接口用于动态覆盖当前加载的 Pipeline 定义。

*   **参数**: `pipeline_override` - 一个 JSON 对象，用于覆盖或修改现有 Pipeline 的行为。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L134-L138)

### MaaResourceGetNodeList

此接口用于获取当前已加载资源中所有任务节点的名称列表。

*   **返回值**: 一个包含所有节点名称的字符串列表。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L199-L203)

## MaaController 接口

MaaController 模块负责与目标设备或应用程序建立连接，并执行具体的控制命令。

### MaaControllerPostConnection

此接口用于异步连接设备。这是一个非阻塞操作，会立即返回。

*   **返回值**: 一个操作 ID，用于查询连接状态。
*   **状态查询**: 可通过 `MaaControllerStatus` 或 `MaaControllerWait` 查询连接操作的状态。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L311-L313)

### MaaControllerPostClick

此接口用于在指定坐标执行异步点击操作。

*   **参数**: `x`, `y` - 点击位置的坐标。
*   **返回值**: 一个操作 ID，用于查询点击操作的状态。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L315-L319)

### MaaControllerPostSwipe

此接口用于执行异步滑动操作。

*   **参数**: `x1`, `y1` - 起始坐标；`x2`, `y2` - 结束坐标；`duration` - 滑动持续时间（毫秒）。
*   **返回值**: 一个操作 ID，用于查询滑动操作的状态。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L321-L327)

### MaaControllerPostScreencap

此接口用于执行异步截图操作。

*   **返回值**: 一个操作 ID，用于查询截图操作的状态。
*   **结果获取**: 截图完成后，可通过 `MaaControllerCachedImage` 获取截图数据。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L415-L417)

## MaaTasker 接口

MaaTasker 是任务执行的核心模块，负责协调资源和控制器来运行具体的自动化任务。

### MaaTaskerCreate 和 MaaTaskerDestroy

*   **MaaTaskerCreate**: 创建一个 MaaTasker 实例。
*   **MaaTaskerDestroy**: 销毁一个 MaaTasker 实例，释放相关资源。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L463-L469)

### MaaTaskerBindResource 和 MaaTaskerBindController

这两个接口用于将 MaaResource 和 MaaController 实例绑定到 MaaTasker 上。

*   **MaaTaskerBindResource**: 关联资源实例。
*   **MaaTaskerBindController**: 关联控制器实例。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L519-L529)

### MaaTaskerPostTask

此接口用于异步启动一个自动化任务。

*   **参数**: `entry` - 任务的入口节点名称；`pipeline_override` - 用于动态覆盖 Pipeline 的 JSON 对象。
*   **返回值**: 一个任务 ID，用于查询任务的执行状态和结果。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L535-L540)

### MaaTaskerGetTaskDetail

此接口用于获取指定任务的详细执行信息。

*   **参数**: `task_id` - 任务的 ID。
*   **返回值**: 包含任务入口、节点列表、执行状态等信息的结构体。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L629-L637)

## 异步与同步操作模式

MaaFramework 的接口设计遵循异步优先的原则，以提高程序的响应性和效率。

### 异步操作

大多数控制和任务接口（如 `PostTask`, `PostConnection`, `PostClick`）都是异步的。它们会立即返回一个操作 ID，而不会等待操作完成。这种模式允许程序在等待设备响应的同时继续执行其他逻辑。

*   **优点**: 高效、非阻塞。
*   **使用场景**: 执行耗时操作（如连接设备、运行任务）时，避免程序卡顿。

### 同步操作

MaaContext 模块提供了一系列同步接口（如 `RunTask`, `RunRecognition`），这些接口会阻塞当前线程，直到操作完成并返回结果。

*   **优点**: 逻辑简单，易于理解。
*   **使用场景**: 在需要立即获取操作结果的简单脚本或特定流程中。

开发者应根据具体需求选择合适的模式。对于复杂的自动化流程，推荐使用异步模式以获得更好的性能和灵活性。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L535-L540)
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L648-L653)

## Python 调用示例

以下是一个使用 Python 调用 MaaFramework 接口的简化示例：

```python
from maa.tasker import Tasker
from maa.resource import Resource
from maa.controller import AdbController

# 创建资源和控制器实例
resource = Resource()
controller = AdbController(adb_path, address, screencap_methods, input_methods)

# 创建任务执行器并绑定资源和控制器
tasker = Tasker()
tasker.bind_resource(resource)
tasker.bind_controller(controller)

# 异步加载资源
load_id = resource.post_path("path/to/resource")
# 等待资源加载完成
resource.wait(load_id)

# 异步连接设备
connect_id = controller.post_connection()
# 等待连接完成
controller.wait(connect_id)

# 异步启动任务
task_id = tasker.post_task("启动游戏")
# 等待任务完成
tasker.wait(task_id)

# 获取任务详情
task_detail = tasker.get_task_detail(task_id)
```

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L7-L15)
- [tasker.py](file://agent/customs/maahelper/tasker.py#L16-L177)

## 关键流程接口调用序列

以下是执行一个完整自动化任务的典型接口调用序列：

1.  **初始化**: 创建 `MaaResource` 和 `MaaController` 实例。
2.  **加载资源**: 调用 `MaaResourcePostBundle` 异步加载任务资源。
3.  **连接设备**: 调用 `MaaControllerPostConnection` 异步连接目标设备。
4.  **绑定与启动**: 创建 `MaaTasker` 实例，将其与资源和控制器绑定，然后调用 `MaaTaskerPostTask` 启动任务。
5.  **状态监控**: 使用 `MaaTaskerStatus` 或 `MaaTaskerWait` 监控任务执行状态。
6.  **结果获取**: 任务完成后，调用 `MaaTaskerGetTaskDetail` 获取执行详情。

此序列确保了资源、设备和任务调度的正确初始化和协调。

**Section sources**
- [main.py](file://agent/main.py#L19-L36)
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L519-L530)

## 错误处理与异常解决方案

MaaFramework 通过返回值和回调机制来报告错误。开发者应始终检查关键操作的返回值。

*   **资源加载失败**: 确保 `path` 参数指向正确的资源目录，并检查文件权限。
*   **连接失败**: 检查设备连接状态、ADB 服务是否正常运行以及 `address` 参数是否正确。
*   **任务执行失败**: 通过 `MaaTaskerGetTaskDetail` 获取详细的错误信息，检查 Pipeline 定义是否正确。

建议在代码中实现重试机制和详细的日志记录，以便于问题排查。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L575-L577)
- [report.py](file://agent/devops/report.py#L9-L34)

## 性能优化建议

*   **操作 ID 管理**: 对于异步操作，及时查询和清理已完成的操作 ID，避免资源泄漏。
*   **回调处理**: 合理使用回调函数来处理事件，避免在回调中执行耗时操作，以免阻塞主线程。
*   **资源复用**: 尽可能复用已创建的 `MaaResource`、`MaaController` 和 `MaaTasker` 实例，避免频繁创建和销毁带来的开销。
*   **批量操作**: 在可能的情况下，将多个小操作合并为一个批次执行，以减少通信开销。

遵循这些建议可以显著提升自动化脚本的执行效率和稳定性。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L575-L577)
- [setup.py](file://agent/preprocess/setup.py#L204-L230)