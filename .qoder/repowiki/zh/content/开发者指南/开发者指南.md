# å¼€å‘è€…æŒ‡å—

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [run_agent.py](file://dev/run_agent.py)
- [build_mfaa.py](file://dev/build_mfaa.py)
- [configure.py](file://tools/configure.py)
- [main.py](file://agent/main.py)
- [setup.py](file://agent/preprocess/setup.py)
- [clear.py](file://agent/preprocess/clear.py)
- [report.py](file://agent/devops/report.py)
- [setup_embed_python.sh](file://ci/setup_embed_python.sh)
- [setup_pip.py](file://ci/setup_pip.py)
- [interface.json](file://assets/interface.json)
- [requirements.txt](file://requirements.txt)
- [MaaDuDuL.py](file://launcher/MaaDuDuL.py)
- [counter.py](file://agent/customs/global_func/counter.py)
- [counter.py](file://agent/customs/utils/counter.py)
- [local_storage.py](file://agent/customs/utils/local_storage.py)
- [__init__.py](file://agent/customs/__init__.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [ç¯å¢ƒæ­å»º](#ç¯å¢ƒæ­å»º)
4. [è°ƒè¯•ä¸è¿è¡Œ](#è°ƒè¯•ä¸è¿è¡Œ)
5. [æ‰“åŒ…ä¸æ„å»º](#æ‰“åŒ…ä¸æ„å»º)
6. [è‡ªå®šä¹‰æ¨¡å—å¼€å‘](#è‡ªå®šä¹‰æ¨¡å—å¼€å‘)
7. [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
8. [CI/CDä¸è‡ªåŠ¨åŒ–éƒ¨ç½²](#cicdä¸è‡ªåŠ¨åŒ–éƒ¨ç½²)
9. [ä»£ç è§„èŒƒä¸æœ€ä½³å®è·µ](#ä»£ç è§„èŒƒä¸æœ€ä½³å®è·µ)
10. [é™„å½•](#é™„å½•)

## ç®€ä»‹
æœ¬æŒ‡å—é¢å‘äºŒæ¬¡å¼€å‘è€…ï¼Œæä¾›MaaDuDuLé¡¹ç›®çš„å®Œæ•´å¼€å‘æµç¨‹æŒ‡å¯¼ã€‚æ¶µç›–ä»ç¯å¢ƒé…ç½®ã€æ¨¡å—å¼€å‘ã€è°ƒè¯•è¿è¡Œåˆ°æ‰“åŒ…å‘å¸ƒçš„å…¨æµç¨‹ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹å¹¶è¿›è¡ŒåŠŸèƒ½æ‰©å±•ã€‚

## é¡¹ç›®ç»“æ„
MaaDuDuLé¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œä¸»è¦ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```mermaid
graph TD
subgraph "æ ¸å¿ƒæ¨¡å—"
A[agent] --> B[customs]
A --> C[preprocess]
A --> D[devops]
end
subgraph "èµ„æºä¸é…ç½®"
E[assets] --> F[resource]
E --> G[MaaCommonAssets]
end
subgraph "å¼€å‘å·¥å…·"
H[dev] --> I[run_agent.py]
H --> J[build_mfaa.py]
end
subgraph "CI/CD"
K[ci] --> L[setup_embed_python.sh]
K --> M[setup_pip.py]
end
subgraph "å·¥å…·è„šæœ¬"
N[tools] --> O[configure.py]
end
P[launcher] --> Q[MaaDuDuL.py]
A --> R[main.py]
S[requirements.txt]
style A fill:#f9f,stroke:#333
style E fill:#f9f,stroke:#333
style H fill:#f9f,stroke:#333
style K fill:#f9f,stroke:#333
style N fill:#f9f,stroke:#333
```

**å›¾ç¤ºæ¥æº**
- [é¡¹ç›®ç»“æ„](file://README.md#L1-L118)

## ç¯å¢ƒæ­å»º
### ä¾èµ–ç®¡ç†
é¡¹ç›®é€šè¿‡`requirements.txt`ç®¡ç†Pythonä¾èµ–ï¼Œæ ¸å¿ƒä¾èµ–åŒ…æ‹¬ï¼š
- `maafw==5.3.0b5`ï¼šMaaFrameworkæ ¸å¿ƒåº“
- `requests==2.32.5`ï¼šHTTPè¯·æ±‚åº“

### é¢„å¤„ç†æµç¨‹
ç¯å¢ƒåˆå§‹åŒ–åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š
1. æ£€æµ‹å¹¶å®‰è£…Pythonä¾èµ–
2. é…ç½®OCRæ¨¡å‹
3. æ¸…ç†è°ƒè¯•æ–‡ä»¶

```mermaid
flowchart TD
Start([å¼€å§‹]) --> CheckVersion["æ£€æŸ¥ç‰ˆæœ¬å˜åŒ–"]
CheckVersion --> VersionChanged{"ç‰ˆæœ¬å˜åŒ–?"}
VersionChanged --> |æ˜¯| InstallDeps["å®‰è£…ä¾èµ–åŒ…"]
VersionChanged --> |å¦| SkipInstall["è·³è¿‡å®‰è£…"]
InstallDeps --> ConfigureOCR["é…ç½®OCRæ¨¡å‹"]
SkipInstall --> ConfigureOCR
ConfigureOCR --> ClearDebug["æ¸…ç†è°ƒè¯•æ–‡ä»¶"]
ClearDebug --> End([ç¯å¢ƒå‡†å¤‡å®Œæˆ])
```

**å›¾ç¤ºæ¥æº**
- [setup.py](file://agent/preprocess/setup.py#L1-L230)
- [configure.py](file://tools/configure.py#L1-L29)
- [clear.py](file://agent/preprocess/clear.py#L1-L41)

**æœ¬èŠ‚æ¥æº**
- [requirements.txt](file://requirements.txt#L1-L3)
- [setup.py](file://agent/preprocess/setup.py#L1-L230)
- [configure.py](file://tools/configure.py#L1-L29)

## è°ƒè¯•ä¸è¿è¡Œ
### è°ƒè¯•æ¨¡å¼å¯åŠ¨
ä½¿ç”¨`run_agent.py`è„šæœ¬å¯åŠ¨è°ƒè¯•æ¨¡å¼ï¼Œè¯¥è„šæœ¬ä¼šï¼š
1. åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•
2. è®¾ç½®å¼€å‘æ¨¡å¼ç¯å¢ƒå˜é‡
3. å¯åŠ¨AgentæœåŠ¡

```mermaid
sequenceDiagram
participant Dev as å¼€å‘è€…
participant Script as run_agent.py
participant Agent as main.py
Dev->>Script : æ‰§è¡Œ python dev/run_agent.py
Script->>Script : åˆ‡æ¢å·¥ä½œç›®å½•
Script->>Script : è®¾ç½® MDDL_DEV_MODE=1
Script->>Agent : å¯åŠ¨ agent/main.py
Agent->>Agent : åˆå§‹åŒ–ç¯å¢ƒ
Agent->>Agent : å¯åŠ¨æœåŠ¡
Agent-->>Dev : æœåŠ¡è¿è¡Œä¸­...
```

**å›¾ç¤ºæ¥æº**
- [run_agent.py](file://dev/run_agent.py#L1-L51)
- [main.py](file://agent/main.py#L1-L48)

### è¿è¡Œæµç¨‹
Agentä¸»ç¨‹åºæ‰§è¡Œæµç¨‹ï¼š
1. æ¸…ç†è°ƒè¯•æ–‡ä»¶
2. åˆå§‹åŒ–MaaFrameworkå·¥å…·åŒ…
3. å¯åŠ¨AgentæœåŠ¡å™¨
4. æ‰§è¡Œæ‰“å¡ä¸ŠæŠ¥
5. ç­‰å¾…æœåŠ¡ç»“æŸ

**æœ¬èŠ‚æ¥æº**
- [run_agent.py](file://dev/run_agent.py#L1-L51)
- [main.py](file://agent/main.py#L1-L48)

## æ‰“åŒ…ä¸æ„å»º
### æ„å»ºæµç¨‹
`build_mfaa.py`è„šæœ¬è´Ÿè´£æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸»è¦æ­¥éª¤ï¼š
1. åˆ›å»ºç›®æ ‡ç›®å½•ç»“æ„
2. å¤åˆ¶èµ„æºæ–‡ä»¶
3. ä¿®æ”¹é…ç½®ä»¥ä½¿ç”¨ç³»ç»ŸPython
4. å¯åŠ¨æ‰“åŒ…åçš„åº”ç”¨

```mermaid
flowchart TD
Start([å¼€å§‹æ„å»º]) --> CreateDir["åˆ›å»ºMFAAvaloniaç›®å½•"]
CreateDir --> CleanOld["æ¸…ç†æ—§æ–‡ä»¶"]
CleanOld --> CopyInterface["å¤åˆ¶interface.json"]
CopyInterface --> ModifyConfig["ä¿®æ”¹é…ç½®ä½¿ç”¨ç³»ç»ŸPython"]
ModifyConfig --> CopyResource["å¤åˆ¶resourceèµ„æº"]
CopyResource --> CopyAgent["å¤åˆ¶agentæ¨¡å—"]
CopyAgent --> ModifyMain["ä¿®æ”¹main.pyè·³è¿‡ä¾èµ–æ£€æŸ¥"]
ModifyMain --> CopyDescs["å¤åˆ¶descsæ–‡æ¡£"]
CopyDescs --> Launch["å¯åŠ¨MFAAvalonia.exe"]
Launch --> End([æ„å»ºå®Œæˆ])
```

**å›¾ç¤ºæ¥æº**
- [build_mfaa.py](file://dev/build_mfaa.py#L1-L118)

### æ‰“åŒ…é…ç½®
æ„å»ºè¿‡ç¨‹ä¸­çš„å…³é”®é…ç½®ä¿®æ”¹ï¼š
- å°†`agent.child_exec`è®¾ç½®ä¸º`python`ï¼Œä½¿ç”¨ç³»ç»ŸPythonç¯å¢ƒ
- ä¿®æ”¹`main.py`è·³è¿‡ä¾èµ–æ£€æŸ¥ï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°ç¯å¢ƒ

**æœ¬èŠ‚æ¥æº**
- [build_mfaa.py](file://dev/build_mfaa.py#L1-L118)
- [interface.json](file://assets/interface.json)

## è‡ªå®šä¹‰æ¨¡å—å¼€å‘
### æ¨¡å—ç»“æ„
è‡ªå®šä¹‰åŠŸèƒ½æ¨¡å—ä½äº`agent/customs/`ç›®å½•ä¸‹ï¼Œä¸»è¦åˆ†ä¸ºï¼š
- `global_func`ï¼šå…¨å±€åŠŸèƒ½æ¨¡å—
- `special_treat`ï¼šç‰¹æ®Šå¤„ç†æ¨¡å—
- `utils`ï¼šå·¥å…·ç±»æ¨¡å—
- `maahelper`ï¼šMaaæ¡†æ¶è¾…åŠ©æ¨¡å—

### å¼€å‘è§„èŒƒ
#### è¯†åˆ«å™¨å¼€å‘
è‡ªå®šä¹‰è¯†åˆ«å™¨éœ€ç»§æ‰¿`CustomRecognition`ç±»ï¼Œå¹¶ä½¿ç”¨`@AgentServer.custom_recognition`è£…é¥°å™¨æ³¨å†Œã€‚

#### æ“ä½œå™¨å¼€å‘
è‡ªå®šä¹‰æ“ä½œå™¨éœ€ç»§æ‰¿`CustomAction`ç±»ï¼Œå¹¶ä½¿ç”¨`@AgentServer.custom_action`è£…é¥°å™¨æ³¨å†Œã€‚

```mermaid
classDiagram
class CustomRecognition {
<<abstract>>
+analyze(context, argv) AnalyzeResult
}
class CustomAction {
<<abstract>>
+run(context, argv) bool
}
class CheckCounter {
+analyze(context, argv) AnalyzeResult
}
class Count {
+run(context, argv) bool
}
class InitCounter {
+run(context, argv) bool
}
CustomRecognition <|-- CheckCounter
CustomAction <|-- Count
CustomAction <|-- InitCounter
CheckCounter --> CounterManager : "ä½¿ç”¨"
Count --> CounterManager : "ä½¿ç”¨"
InitCounter --> CounterManager : "ä½¿ç”¨"
```

**å›¾ç¤ºæ¥æº**
- [counter.py](file://agent/customs/global_func/counter.py#L1-L118)
- [counter.py](file://agent/customs/utils/counter.py#L1-L141)

### å‚æ•°å¤„ç†
ä½¿ç”¨`ParamAnalyzer`ç±»å¤„ç†è¿è¡Œå‚æ•°ï¼Œæ”¯æŒï¼š
- å¤šåˆ«åå‚æ•°ï¼ˆå¦‚`key`å’Œ`k`ï¼‰
- é»˜è®¤å€¼è®¾ç½®
- ç±»å‹è½¬æ¢

### æ³¨å†Œæœºåˆ¶
é€šè¿‡è£…é¥°å™¨è‡ªåŠ¨æ³¨å†Œåˆ°AgentServerï¼Œæ³¨å†Œåç§°å³ä¸ºæµæ°´çº¿ä¸­å¼•ç”¨çš„åç§°ã€‚

**æœ¬èŠ‚æ¥æº**
- [counter.py](file://agent/customs/global_func/counter.py#L1-L118)
- [counter.py](file://agent/customs/utils/counter.py#L1-L141)
- [__init__.py](file://agent/customs/__init__.py#L1-L3)

## é…ç½®ç®¡ç†
### é…ç½®æ–‡ä»¶
é¡¹ç›®ä½¿ç”¨å¤šç§é…ç½®æ–‡ä»¶ï¼š
- `pip_config.json`ï¼špipå®‰è£…é…ç½®
- `local_storage.json`ï¼šæœ¬åœ°å­˜å‚¨é…ç½®
- `interface.json`ï¼šé¡¹ç›®æ¥å£é…ç½®

### é…ç½®ç®¡ç†ç±»
`LocalStorage`ç±»æä¾›JSONæ ¼å¼çš„é”®å€¼å­˜å‚¨ï¼Œç”¨äºæŒä¹…åŒ–é…ç½®å’ŒçŠ¶æ€æ•°æ®ã€‚

```mermaid
classDiagram
class LocalStorage {
+_ensure_storage_file() void
+_read() dict
+_write(storage) bool
+get(key) any
+set(key, value) bool
}
class CounterManager {
+get(key, max_count, initial_count) Counter
+remove(key) CounterManager
+clear_all() CounterManager
}
class Counter {
+count() int
+reset() Counter
+cur_count int
+max_count int
+is_max bool
}
LocalStorage --> CounterManager : "æŒä¹…åŒ–è®¡æ•°å™¨çŠ¶æ€"
CounterManager o-- Counter : "ç®¡ç†"
```

**å›¾ç¤ºæ¥æº**
- [local_storage.py](file://agent/customs/utils/local_storage.py#L1-L111)
- [counter.py](file://agent/customs/utils/counter.py#L1-L141)

**æœ¬èŠ‚æ¥æº**
- [configure.py](file://tools/configure.py#L1-L29)
- [local_storage.py](file://agent/customs/utils/local_storage.py#L1-L111)

## CI/CDä¸è‡ªåŠ¨åŒ–éƒ¨ç½²
### åµŒå…¥å¼Pythonå®‰è£…
`setup_embed_python.sh`è„šæœ¬ç”¨äºåœ¨Unixå¹³å°å®‰è£…åµŒå…¥å¼Pythonï¼Œä¸»è¦åŠŸèƒ½ï¼š
1. æ£€æµ‹æ“ä½œç³»ç»Ÿå’Œæ¶æ„
2. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„Python
3. è§£å‹å¹¶é…ç½®ç¯å¢ƒ
4. å®‰è£…pipåŒ…ç®¡ç†å™¨

```mermaid
sequenceDiagram
participant User as ç”¨æˆ·
participant Script as setup_embed_python.sh
participant GitHub as GitHub Releases
User->>Script : æ‰§è¡Œè„šæœ¬
Script->>Script : æ£€æµ‹ç³»ç»Ÿæ¶æ„
Script->>GitHub : ä¸‹è½½Python
GitHub-->>Script : è¿”å›å‹ç¼©åŒ…
Script->>Script : è§£å‹Python
Script->>Script : å®‰è£…pip
Script->>User : å®‰è£…å®Œæˆ
```

**å›¾ç¤ºæ¥æº**
- [setup_embed_python.sh](file://ci/setup_embed_python.sh#L1-L132)

### è‡ªåŠ¨åŒ–æµç¨‹
CI/CDæµç¨‹åŒ…æ‹¬ï¼š
1. ç¯å¢ƒå‡†å¤‡
2. ä¾èµ–å®‰è£…
3. æ„å»ºæ‰“åŒ…
4. æµ‹è¯•éªŒè¯

**æœ¬èŠ‚æ¥æº**
- [setup_embed_python.sh](file://ci/setup_embed_python.sh#L1-L132)
- [setup_pip.py](file://ci/setup_pip.py)

## ä»£ç è§„èŒƒä¸æœ€ä½³å®è·µ
### ä»£ç é£æ ¼
éµå¾ªPython PEP 8è§„èŒƒï¼Œä¸»è¦è¦æ±‚ï¼š
- ä½¿ç”¨4ä¸ªç©ºæ ¼ç¼©è¿›
- è¡Œé•¿åº¦ä¸è¶…è¿‡79å­—ç¬¦
- ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åæ³•
- æ·»åŠ é€‚å½“çš„æ–‡æ¡£å­—ç¬¦ä¸²

### æ—¥å¿—è°ƒè¯•
ä½¿ç”¨æ ‡å‡†è¾“å‡ºè¿›è¡Œæ—¥å¿—è®°å½•ï¼Œå‰ç¼€è§„èŒƒï¼š
- `info:`ï¼šä¿¡æ¯æ€§æ—¥å¿—
- `âš ï¸`ï¼šè­¦å‘Šä¿¡æ¯
- `âŒ`ï¼šé”™è¯¯ä¿¡æ¯
- `ğŸš€`ï¼šå¯åŠ¨ä¿¡æ¯

### æ€§èƒ½ä¼˜åŒ–
1. ä½¿ç”¨ç±»æ–¹æ³•å‡å°‘å®ä¾‹åŒ–å¼€é”€
2. ç¼“å­˜é¢‘ç¹è®¿é—®çš„æ•°æ®
3. å¼‚å¸¸å¤„ç†é¿å…ç¨‹åºä¸­æ–­
4. èµ„æºæ–‡ä»¶æŒ‰éœ€åŠ è½½

### æœ€ä½³å®è·µç¤ºä¾‹
```mermaid
flowchart TD
Start([å¼€å§‹]) --> ValidateInput["éªŒè¯è¾“å…¥å‚æ•°"]
ValidateInput --> InputValid{"å‚æ•°æœ‰æ•ˆ?"}
InputValid --> |å¦| ReturnError["è¿”å›é”™è¯¯"]
InputValid --> |æ˜¯| CheckCache["æ£€æŸ¥ç¼“å­˜"]
CheckCache --> CacheHit{"ç¼“å­˜å‘½ä¸­?"}
CacheHit --> |æ˜¯| ReturnCache["è¿”å›ç¼“å­˜æ•°æ®"]
CacheHit --> |å¦| ProcessData["å¤„ç†æ•°æ®"]
ProcessData --> UpdateCache["æ›´æ–°ç¼“å­˜"]
UpdateCache --> ReturnResult["è¿”å›ç»“æœ"]
ReturnError --> End([ç»“æŸ])
ReturnCache --> End
ReturnResult --> End
```

**æœ¬èŠ‚æ¥æº**
- [æ‰€æœ‰Pythonæ–‡ä»¶](file://*.py)

## é™„å½•
### å¸¸è§é—®é¢˜
1. **ç¯å¢ƒå˜é‡æœªè®¾ç½®**ï¼šç¡®ä¿`MDDL_DEV_MODE`æ­£ç¡®è®¾ç½®
2. **ä¾èµ–å®‰è£…å¤±è´¥**ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æ›´æ¢é•œåƒæº
3. **æ¨¡å—æ³¨å†Œå¤±è´¥**ï¼šç¡®è®¤è£…é¥°å™¨ä½¿ç”¨æ­£ç¡®

### è°ƒè¯•æŠ€å·§
- ä½¿ç”¨`debug`ç›®å½•æŸ¥çœ‹è°ƒè¯•æˆªå›¾
- æ£€æŸ¥`logs`ç›®å½•çš„æ—¥å¿—æ–‡ä»¶
- é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶è°ƒè¯•è¾“å‡º

### å‚è€ƒæ–‡æ¡£
- [MaaFrameworkæ–‡æ¡£](https://github.com/MaaXYZ/MaaFramework)
- [Pythonæœ€ä½³å®è·µ](https://peps.python.org/pep-0008/)