# 日常任务功能

<cite>
**本文档引用文件**  
- [claim_mail.md](file://descs/daily/claim_mail.md)
- [claim_candy.md](file://descs/daily/claim_candy.md)
- [purchase.md](file://descs/daily/purchase.md)
- [clear_purple_candy.md](file://descs/daily/clear_purple_candy.md)
- [leaf_change.md](file://descs/daily/leaf_change.md)
- [claim_reward.md](file://descs/daily/claim_reward.md)
- [activity.py](file://agent/customs/special_treat/activity.py)
- [eat_sugar.py](file://agent/customs/special_treat/eat_sugar.py)
- [store.py](file://agent/customs/special_treat/store.py)
- [receive_reward.py](file://agent/customs/special_treat/receive_reward.py)
</cite>

## 目录
1. [功能概述](#功能概述)
2. [子功能执行流程解析](#子功能执行流程解析)
3. [OCR识别与模拟点击机制](#ocr识别与模拟点击机制)
4. [Pipeline配置结构分析](#pipeline配置结构分析)
5. [界面导航路径与异常恢复策略](#界面导航路径与异常恢复策略)
6. [执行频率建议与效率评估](#执行频率建议与效率评估)
7. [兼容性注意事项](#兼容性注意事项)

## 功能概述

MaaDuDuL的日常任务自动化功能旨在通过自动化脚本完成游戏中的重复性操作，提升资源获取效率。该功能模块包含“领取邮件”、“领取糖果”、“每日采购”、“清紫糖”、“叶子互换”和“领取奖励”等子功能，均被标记为【可连续任务】【日常任务】，支持从任意界面启动，并在执行完毕后返回主界面。

这些功能通过MaaFramework提供的自定义动作（CustomAction）机制实现，结合OCR识别、图像匹配与模拟点击技术，精准定位界面元素并触发交互。所有任务均以模块化方式组织于`agent/customs/special_treat`目录下，便于维护与扩展。

**本节来源**  
- [claim_mail.md](file://descs/daily/claim_mail.md)
- [claim_candy.md](file://descs/daily/claim_candy.md)
- [purchase.md](file://descs/daily/purchase.md)
- [clear_purple_candy.md](file://descs/daily/clear_purple_candy.md)
- [leaf_change.md](file://descs/daily/leaf_change.md)
- [claim_reward.md](file://descs/daily/claim_reward.md)

## 子功能执行流程解析

### 领取邮件

“领取邮件”功能负责自动收取游戏内邮件奖励。其执行流程从任意界面开始，通过通用导航流程进入主界面，识别邮件图标并点击进入邮件页面，逐一领取可领取的奖励，最后返回主界面。

该功能由`descs/daily/claim_mail.md`文档说明，实际执行依赖于Pipeline配置中的“领取邮件”任务节点，通过图像匹配检测邮件红点提示，确保无遗漏。

**本节来源**  
- [claim_mail.md](file://descs/daily/claim_mail.md)

### 领取糖果

“领取糖果”功能根据时间段（早饭/晚饭）自动领取对应奖励。其实现逻辑位于`activity.py`中的`ClaimCandy`类，通过参数`time/t`区分领取时段。

代码中根据不同时段设置不同的ROI（Region of Interest）区域：
- 早饭糖果：`[509, 465, 278, 105]`
- 晚饭糖果：`[821, 464, 281, 108]`

系统通过周期性检查机制（`领取糖果_周期检查`）判断是否已领取，避免重复操作，并在领取后记录状态。

**本节来源**  
- [claim_candy.md](file://descs/daily/claim_candy.md)
- [activity.py](file://agent/customs/special_treat/activity.py#L60-L102)

### 每日采购

“每日采购”功能涵盖免费礼包领取与商店商品购买。其实现分为两个自定义动作类：
- `Gift`：用于领取指定名称的礼包
- `Buy`：用于购买指定名称的商品

两个类均通过`ParamAnalyzer`解析输入参数（如`gift/g`或`goods/g`），并调用`Tasker`运行对应的Pipeline任务，如“每日采购_选中礼包”或“每日采购_查看商品详情”，实现精准操作。

**本节来源**  
- [purchase.md](file://descs/daily/purchase.md)
- [store.py](file://agent/customs/special_treat/store.py#L14-L96)

### 清紫糖

“清紫糖”功能用于清理紫色糖果副本，获取角色培养材料。其实现位于`eat_sugar.py`中的多个类：
- `SelectCloneLevel`：选择克隆工厂关卡（4列布局）
- `SelectCrayonLevel`：选择到手蜡关卡（5列布局）
- `SelectDuplicateLevel`：通过OCR查找指定副本关卡

对于前两种，系统使用`MatrixOperator`根据起始坐标与行列间隔计算点击位置；对于第三种，则通过OCR识别关卡编号（自动补零处理），实现灵活关卡选择。

**本节来源**  
- [clear_purple_candy.md](file://descs/daily/clear_purple_candy.md)
- [eat_sugar.py](file://agent/customs/special_treat/eat_sugar.py#L21-L206)

### 叶子互换

“叶子互换”功能实现自动收取与赠送好友叶子。其文档说明位于`descs/daily/leaf_change.md`，表明其为日常可连续任务，起止界面为任意界面至主界面。

虽然具体实现代码未直接展示，但可推断其通过进入社交界面，识别“收取”与“赠送”按钮，执行批量操作完成自动化。

**本节来源**  
- [leaf_change.md](file://descs/daily/leaf_change.md)

### 领取奖励

“领取奖励”功能分为两类：
- `ReceiveTaskReward`：领取每日/每周任务奖励
- `ReceivePassReward`：领取通行证奖励（等级、便装、冒险）

两类均通过参数`category/c`指定奖励类型。系统根据类别进入对应面板或加载对应模板图像（如`main/grade_pass.png`），触发领取流程。

**本节来源**  
- [claim_reward.md](file://descs/daily/claim_reward.md)
- [receive_reward.py](file://agent/customs/special_treat/receive_reward.py#L9-L65)

## OCR识别与模拟点击机制

MaaDuDuL利用MaaFramework内置的OCR引擎（基于PPOCRv3/v4/v5）进行界面元素识别。OCR主要用于以下场景：
- 文本匹配：如活动标题、礼包名称、商品名、任务类别
- 数字识别：如关卡编号（自动补零处理）
- 状态判断：如“已领取”、“未找到”等提示文本

当OCR识别到目标元素后，系统结合ROI区域与坐标偏移，通过`Tasker.click(x, y)`触发模拟点击。对于固定布局的界面（如克隆工厂），使用`MatrixOperator`类根据行列公式计算精确坐标，提高点击准确性。

此外，系统支持模板匹配（Template Matching）作为OCR的补充，用于识别图标、按钮等非文本元素，如通行证界面入口。

**本节来源**  
- [activity.py](file://agent/customs/special_treat/activity.py#L35-L54)
- [eat_sugar.py](file://agent/customs/special_treat/eat_sugar.py#L17-L18)
- [store.py](file://agent/customs/special_treat/store.py#L11-L12)

## Pipeline配置结构分析

日常任务的执行流程由JSON格式的Pipeline文件定义，位于`assets/resource/base/pipeline/日常任务/`目录下。每个任务对应一个独立的JSON文件，如“领取邮件.json”。

Pipeline节点结构包含以下关键字段：
- `name`：节点名称，用于流程控制
- `type`：节点类型（如`TemplateMatch`、`OCR`、`Click`）
- `roi`：匹配区域，限定识别范围
- `expected`：期望匹配的文本内容
- `template`：模板图像路径，用于图像匹配
- `next`：成功后的跳转节点
- `timeout`：超时时间，防止卡死
- `retry`：重试次数，应对网络延迟或识别失败

例如，“领取糖果_点击领取”节点设置`roi`以精确定位按钮区域，配合“已领取”节点防止重复点击，形成闭环控制逻辑。

**本节来源**  
- [activity.py](file://agent/customs/special_treat/activity.py#L40-L47)
- [store.py](file://agent/customs/special_treat/store.py#L40-L45)

## 界面导航路径与异常恢复策略

所有日常任务均支持从任意界面启动，依赖“回到主界面”或“懒加载返回主界面”等通用Pipeline节点完成初始导航。系统通过周期性检查（`periodic_check`模块）检测弹窗、公告等干扰元素，并自动关闭，确保流程连续性。

在网络延迟或操作失败时，系统采用以下恢复策略：
- **重试机制**：关键节点配置`retry`字段，失败后自动重试
- **超时跳转**：设置`timeout`后跳转至恢复节点
- **状态检测**：通过OCR或图像匹配确认当前界面状态，动态调整流程
- **异常捕获**：所有自定义动作均使用`try-except`包裹，记录错误日志并返回`False`

例如，在“领取奖励”任务中，若未找到指定任务面板，系统会记录错误并通过`Prompter.error`提示用户，同时不影响整体流程退出。

**本节来源**  
- [activity.py](file://agent/customs/special_treat/activity.py#L50-L54)
- [eat_sugar.py](file://agent/customs/special_treat/eat_sugar.py#L60-L62)
- [receive_reward.py](file://agent/customs/special_treat/receive_reward.py#L31-L33)

## 执行频率建议与效率评估

| 功能 | 建议执行频率 | 资源获取效率 | 备注 |
|------|--------------|--------------|------|
| 领取邮件 | 每日1次 | 高 | 包含登录奖励与系统邮件 |
| 领取糖果 | 每日2次（早/晚） | 高 | 固定时间刷新，建议准时执行 |
| 每日采购 | 每日1次 | 中 | 含免费礼包与货币购买商品 |
| 清紫糖 | 每日1次 | 高 | 核心材料来源，建议优先执行 |
| 叶子互换 | 每日1次 | 低 | 社交互动奖励，不影响主线 |
| 领取奖励 | 每日1次 | 高 | 涵盖任务与通行证双重收益 |

综合来看，“清紫糖”、“领取糖果”和“领取奖励”为高价值任务，建议每日优先执行。所有任务均可串联为“日常任务流水线”，实现一键全自动完成。

**本节来源**  
- [claim_mail.md](file://descs/daily/claim_mail.md)
- [claim_candy.md](file://descs/daily/claim_candy.md)
- [purchase.md](file://descs/daily/purchase.md)
- [clear_purple_candy.md](file://descs/daily/clear_purple_candy.md)
- [leaf_change.md](file://descs/daily/leaf_change.md)
- [claim_reward.md](file://descs/daily/claim_reward.md)

## 兼容性注意事项

- **版本兼容性**：确保游戏版本与Pipeline配置匹配，界面变更可能导致OCR识别失败
- **多任务冲突**：避免与其他自动化功能（如连续作战）同时运行，防止资源竞争
- **网络稳定性**：弱网环境下建议增加`timeout`与`retry`值，防止误判
- **设备适配**：不同分辨率设备需调整ROI与坐标参数，建议使用相对坐标计算
- **更新同步**：游戏活动更新后，需同步更新`activity.py`中的`EnterActivity`逻辑与OCR关键词

建议定期检查`descs/daily/`目录下的文档说明，了解最新功能变更与使用限制。

**本节来源**  
- [activity.py](file://agent/customs/special_treat/activity.py)
- [eat_sugar.py](file://agent/customs/special_treat/eat_sugar.py)
- [store.py](file://agent/customs/special_treat/store.py)