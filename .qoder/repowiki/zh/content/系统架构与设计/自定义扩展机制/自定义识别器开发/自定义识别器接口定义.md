# 自定义识别器接口定义

<cite>
**本文档引用的文件**   
- [MaaAgentServerAPI.h](file://deps/include/MaaAgentServer/MaaAgentServerAPI.h)
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md)
- [agent_child.cpp](file://deps/sample/cpp/MaaAgent/agent_child.cpp)
- [main.py](file://agent/main.py)
- [logic_enhance.py](file://agent/customs/global_func/logic_enhance.py)
- [reco_helper.py](file://agent/customs/maahelper/reco_helper.py)
- [argv_analyzer.py](file://agent/customs/maahelper/argv_analyzer.py)
- [prompter.py](file://agent/customs/utils/prompter.py)
</cite>

## 目录
1. [接口参数定义](#接口参数定义)
2. [name参数作用机制](#name参数作用机制)
3. [recognition回调函数签名](#recognition回调函数签名)
4. [trans_arg参数应用场景](#trans_arg参数应用场景)
5. [注册时机与服务生命周期](#注册时机与服务生命周期)
6. [使用示例与错误处理](#使用示例与错误处理)

## 接口参数定义

`MaaAgentServerRegisterCustomRecognition` 接口用于注册自定义识别器，其参数定义如下：

- **name**: 识别器名称，作为唯一标识符
- **recognition**: 自定义识别回调函数
- **trans_arg**: 传递给回调函数的参数

该接口在 C 语言头文件中的定义为：
```c
MaaBool MaaAgentServerRegisterCustomRecognition(const char* name, MaaCustomRecognitionCallback recognition, void* trans_arg);
```

**Section sources**
- [MaaAgentServerAPI.h](file://deps/include/MaaAgentServer/MaaAgentServerAPI.h#L10)
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L953-L960)

## name参数作用机制

`name` 参数作为自定义识别器的唯一标识符，在系统中起到关键作用：

1. **唯一性标识**：每个注册的自定义识别器必须有唯一的名称，用于在任务配置中引用
2. **配置引用**：在 Pipeline 配置文件中通过该名称调用自定义识别器
3. **多实例管理**：系统通过名称区分不同的自定义识别器实例
4. **生命周期管理**：名称与识别器实例的生命周期绑定，用于资源管理和清理

当在 Pipeline 中配置使用自定义识别器时，需要在 `recognition` 字段中指定注册时使用的名称。

**Section sources**
- [2.2-集成接口一览.md](file://instructions/maafw-guide/2.2-集成接口一览.md#L956-L960)
- [agent_child.cpp](file://deps/sample/cpp/MaaAgent/agent_child.cpp#L41)

## recognition回调函数签名

自定义识别回调函数的签名要求如下：

```c
typedef MaaBool(MAA_CALL* MaaCustomRecognitionCallback)(
    MaaContext* context,
    MaaTaskId task_id,
    const char* node_name,
    const char* custom_recognition_name,
    const char* custom_recognition_param,
    const MaaImageBuffer* image,
    const MaaRect* roi,
    void* trans_arg,
    /* out */ MaaRect* out_box,
    /* out */ MaaStringBuffer* out_detail
);
```

各参数的类型与用途说明：

- **context**: `MaaContext*` 类型，MAA 上下文对象，提供各种操作接口
- **task_id**: `MaaTaskId` 类型，当前任务的唯一标识符
- **node_name**: `const char*` 类型，当前节点的名称
- **custom_recognition_name**: `const char*` 类型，自定义识别器的名称（即注册时的 name 参数）
- **custom_recognition_param**: `const char*` 类型，自定义识别器的参数，通常为 JSON 字符串
- **image**: `const MaaImageBuffer*` 类型，当前屏幕截图的图像数据
- **roi**: `const MaaRect*` 类型，识别区域（感兴趣区域）
- **trans_arg**: `void*` 类型，注册时传递的用户自定义参数
- **out_box**: `MaaRect*` 类型，输出参数，识别结果的边界框
- **out_detail**: `MaaStringBuffer*` 类型，输出参数，识别结果的详细信息

**Section sources**
- [MaaAgentServerAPI.h](file://deps/include/MaaAgentServer/MaaAgentServerAPI.h#L7-L17)
- [agent_child.cpp](file://deps/sample/cpp/MaaAgent/agent_child.cpp#L7-L17)

## trans_arg参数应用场景

`trans_arg` 参数在跨识别周期数据传递中具有多种重要应用场景：

### 状态保持
通过 `trans_arg` 可以在多次识别调用之间保持状态信息，如计数器、识别历史等。例如在 `logic_enhance.py` 中的 `StableReco` 类使用计数器来实现稳定识别功能，确保连续多次识别到同一目标才确认结果。

### 配置传递
将配置对象或参数通过 `trans_arg` 传递给回调函数，避免全局变量的使用，提高代码的可维护性和可测试性。可以在注册时将配置对象传入，在每次识别时都能访问最新的配置。

### 上下文共享
在复杂的识别逻辑中，可能需要共享一些辅助对象或工具类实例。通过 `trans_arg` 可以传递这些共享对象，如日志记录器、网络客户端、数据库连接等。

### 性能优化
通过 `trans_arg` 传递预分配的缓冲区或缓存对象，避免在每次识别调用时重复创建和销毁对象，提高性能。

**Section sources**
- [logic_enhance.py](file://agent/customs/global_func/logic_enhance.py#L18-L96)
- [reco_helper.py](file://agent/customs/maahelper/reco_helper.py#L34-L200)
- [argv_analyzer.py](file://agent/customs/maahelper/argv_analyzer.py#L30-L45)

## 注册时机与服务生命周期

结合 `agent/main.py` 中的 `AgentServer.start_up` 调用上下文，注册时机与服务生命周期的关系如下：

```python
def main():
    """启动 MaaDuDuL Agent 服务"""
    from maa.agent.agent_server import AgentServer
    from maa.toolkit import Toolkit
    from agent import customs
    from agent.preprocess import clear
    from agent.devops import punch_in

    try:
        # 清理调试文件
        clear()
        # 初始化 MaaFW 工具包
        Toolkit.init_option("./")
        # 获取 socket ID 并启动服务
        socket_id = sys.argv[-1]
        AgentServer.start_up(socket_id)
        # devops
        punch_in()
        # 等待服务结束
        AgentServer.join()
        AgentServer.shut_down()

    except Exception as e:
        print(f"info:Agent 启动失败：{e}")
        sys.exit(1)
```

注册时机的关键点：

1. **启动前注册**：自定义识别器必须在 `AgentServer.start_up` 调用之前完成注册
2. **初始化阶段**：通常在服务初始化阶段，导入自定义模块并注册识别器
3. **单次注册**：每个识别器只需注册一次，在服务生命周期内持续有效
4. **关闭清理**：在 `AgentServer.shut_down` 调用后，所有注册的识别器将被清理

正确的注册流程应该是：初始化工具包 → 注册自定义识别器 → 启动服务 → 等待服务运行 → 关闭服务。

**Section sources**
- [main.py](file://agent/main.py#L17-L48)
- [logic_enhance.py](file://agent/customs/global_func/logic_enhance.py#L18)

## 使用示例与错误处理

### 基础识别器注册示例

```python
from maa.agent.agent_server import AgentServer
from maa.custom_recognition import CustomRecognition
from maa.context import Context

@AgentServer.custom_recognition("my_custom_reco")
class MyCustomReco(CustomRecognition):
    def analyze(
        self,
        context: Context,
        argv: CustomRecognition.AnalyzeArg,
    ) -> CustomRecognition.AnalyzeResult:
        try:
            # 执行识别逻辑
            # ...
            return CustomRecognition.AnalyzeResult(
                box=(x, y, w, h),
                detail={"hit": True, "text": "识别结果"}
            )
        except Exception as e:
            return Prompter.error("自定义识别", e, reco_detail=True)
```

### 错误处理最佳实践

1. **异常捕获**：在 `analyze` 方法中使用 try-catch 捕获所有异常
2. **详细日志**：记录错误详情，便于调试和问题定位
3. **优雅降级**：在发生错误时返回合理的默认结果，避免服务中断
4. **资源清理**：确保在异常情况下正确释放资源
5. **错误传播**：通过 `reco_detail` 参数传递错误信息，供上层处理

```python
def analyze(self, context: Context, argv: CustomRecognition.AnalyzeArg) -> CustomRecognition.AnalyzeResult:
    try:
        # 识别逻辑
        pass
    except Exception as e:
        return Prompter.error("识别失败", e, reco_detail=True)
```

**Section sources**
- [logic_enhance.py](file://agent/customs/global_func/logic_enhance.py#L18-L96)
- [prompter.py](file://agent/customs/utils/prompter.py#L34-L54)
- [reco_helper.py](file://agent/customs/maahelper/reco_helper.py#L34-L200)