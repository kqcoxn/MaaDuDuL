# 输入类型配置

<cite>
**本文档引用文件**   
- [interface.json](file://assets/interface.json#L768-L785)
- [eat_sugar.py](file://agent/customs/special_treat/eat_sugar.py#L65-L118)
- [argv_analyzer.py](file://agent/customs/maahelper/argv_analyzer.py#L30-L132)
- [清紫糖.json](file://assets/resource/base/pipeline/日常任务/清紫糖.json#L635-L649)
</cite>

## 目录
1. [输入配置项工作流程](#输入配置项工作流程)
2. [以“清紫糖-克隆工厂-选择关卡”为例的完整执行机制](#以清紫糖-克隆工厂-选择关卡为例的完整执行机制)
3. [用户输入到流水线的动态参数传递](#用户输入到流水线的动态参数传递)
4. [输入值类型转换与验证反馈](#输入值类型转换与验证反馈)
5. [正确配置与常见错误示例](#正确配置与常见错误示例)

## 输入配置项工作流程

输入类型配置（`type: input`）是MaaDuDuL自动化系统中用于接收用户自定义参数的核心机制。其工作流程始于用户界面的输入框，通过结构化配置定义输入字段的名称、标签、默认值、数据类型及验证规则。当用户提交输入后，系统会依据预设的正则表达式进行合法性校验，确保输入符合预期格式。校验通过的输入值将作为动态参数，通过`pipeline_override`机制注入到任务流水线中，从而实现对自动化流程的精确控制。

该机制的关键在于将用户输入与底层自动化逻辑无缝连接。通过`inputs`数组定义的每个输入字段，不仅提供了用户友好的交互界面，还通过`pipeline_type`指定了数据类型，确保参数在传递过程中保持正确的格式。最终，这些参数通过自定义动作（Custom Action）被解析并执行，驱动自动化任务按用户指定的参数运行。

**Section sources**
- [interface.json](file://assets/interface.json#L768-L785)

## 以“清紫糖-克隆工厂-选择关卡”为例的完整执行机制

“清紫糖-克隆工厂-选择关卡”是输入类型配置的一个典型应用实例。该配置项允许用户指定在“清紫糖”任务中需要刷取的克隆工厂关卡编号。

在`interface.json`文件中，该配置项被定义为一个`input`类型：
```json
"清紫糖-克隆工厂-选择关卡": {
    "type": "input",
    "label": "克隆工厂关卡",
    "description": "请选择可速刷的关卡",
    "inputs": [
        {
            "name": "关卡",
            "label": "克隆工厂关卡",
            "default": "1",
            "pipeline_type": "string",
            "verify": "^\\d+$"
        }
    ],
    "pipeline_override": {
        "清紫糖_选择克隆工厂关卡": {
            "custom_action_param": "l={关卡}"
        }
    }
}
```

其执行机制如下：
1.  **配置解析**：系统读取`interface.json`，识别出`清紫糖-克隆工厂-选择关卡`是一个输入类型配置项。
2.  **界面渲染**：在用户界面中，根据`label`字段显示“克隆工厂关卡”作为输入框的标签，并根据`description`提供提示信息。
3.  **默认值应用**：由于`inputs`中的`default`字段被设置为`"1"`，输入框会预填充数字`1`，作为用户不进行修改时的默认关卡。
4.  **输入验证**：`verify`字段的正则表达式`^\\d+$`确保用户只能输入一个或多个连续的数字。任何包含非数字字符（如字母、符号）或为空的输入都将被系统拒绝，并提示用户重新输入。
5.  **参数注入**：当用户输入有效值（例如`5`）并确认后，该值将被用于替换`pipeline_override`中的`{关卡}`占位符。

**Section sources**
- [interface.json](file://assets/interface.json#L768-L785)

## 用户输入到流水线的动态参数传递

用户输入的值通过`pipeline_override`和`custom_action_param`参数实现向流水线的动态注入，这是整个机制的核心。

在“清紫糖-克隆工厂-选择关卡”的配置中，`pipeline_override`指定了当此选项被激活时，需要覆盖流水线中名为`清紫糖_选择克隆工厂关卡`的节点的行为。具体覆盖的内容是该节点的`custom_action_param`参数，其值为`l={关卡}`。

这个过程可以分解为：
1.  **占位符替换**：系统将`{关卡}`视为一个占位符。当用户输入一个值（如`3`）时，系统会将`{关卡}`替换为用户输入的实际值，从而生成最终的参数字符串`l=3`。
2.  **自定义动作执行**：`清紫糖_选择克隆工厂关卡`节点在流水线中被定义为一个“自定义动作”（Custom Action），其类型为`select_clone_level`。
3.  **参数解析**：在`agent/customs/special_treat/eat_sugar.py`文件中，`SelectCloneLevel`类的`run`方法会接收这个`custom_action_param`。它使用`ParamAnalyzer`工具类来解析这个参数字符串。
    ```python
    args = ParamAnalyzer(argv)
    level: int = args.get(["level", "l"])
    ```
    这段代码会解析`l=3`，并提取出键`l`对应的值`3`，将其赋值给`level`变量。
4.  **逻辑执行**：`SelectCloneLevel`类根据解析出的`level`值，利用`MatrixOperator`计算出该关卡在屏幕上的精确坐标，并通过`Tasker`执行点击操作，从而完成关卡选择。

```mermaid
sequenceDiagram
    participant UI as 用户界面
    participant Config as interface.json
    participant Pipeline as 任务流水线
    participant Action as 自定义动作

    UI->>Config: 用户输入关卡号 (如 5)
    Config->>Config: 使用 verify: ^\\d+$ 校验输入
    alt 输入有效
        Config->>Pipeline: pipeline_override: l={关卡}
        Pipeline->>Pipeline: 替换 {关卡} 为 5, 得到 l=5
        Pipeline->>Action: 执行 清紫糖_选择克隆工厂关卡, 参数 l=5
        Action->>Action: ParamAnalyzer 解析 l=5
        Action->>Action: 获取 level = 5
        Action->>Action: 计算坐标并点击
    else 输入无效
        UI-->>UI: 显示错误提示，要求重新输入
    end

**Diagram sources **
- [interface.json](file://assets/interface.json#L768-L785)
- [eat_sugar.py](file://agent/customs/special_treat/eat_sugar.py#L65-L118)
- [argv_analyzer.py](file://agent/customs/maahelper/argv_analyzer.py#L30-L132)

**Section sources**
- [interface.json](file://assets/interface.json#L768-L785)
- [eat_sugar.py](file://agent/customs/special_treat/eat_sugar.py#L65-L118)
- [argv_analyzer.py](file://agent/customs/maahelper/argv_analyzer.py#L30-L132)

## 输入值类型转换与验证反馈

输入值的类型转换和验证反馈是确保系统稳定运行的关键环节。

**类型转换**：
`pipeline_type`字段明确指定了输入值在注入流水线前应转换为何种数据类型。在本例中，`pipeline_type`被设置为`"string"`，这意味着无论用户输入的是`1`还是`10`，它们都会以字符串形式（`"1"`, `"10"`）被传递给`custom_action_param`。尽管`ParamAnalyzer`内部会尝试将数字字符串转换为`int`或`float`（如`eat_sugar.py`中的`args.get(["level", "l"])`），但`pipeline_type`确保了在参数传递的初始阶段，数据是以字符串形式存在的。这为参数的拼接和处理提供了灵活性。

**验证反馈**：
验证机制由`verify`字段的正则表达式驱动。系统在用户提交输入后立即进行校验。
- **成功反馈**：如果输入匹配正则`^\\d+$`（即一个或多个数字），输入被接受，流程继续。
- **失败反馈**：如果输入包含非数字字符（如`a`、`1.5`、`-1`或空值），校验失败。系统会阻止任务启动，并在用户界面上给出明确的错误提示，要求用户输入一个有效的正整数。这种即时反馈机制能有效防止因错误参数导致的自动化流程中断或错误操作。

**Section sources**
- [interface.json](file://assets/interface.json#L768-L785)
- [argv_analyzer.py](file://agent/customs/maahelper/argv_analyzer.py#L48-L101)

## 正确配置与常见错误示例

### 正确配置示例
- **输入值**：`1`, `5`, `12`
- **说明**：这些值都是有效的正整数，完全符合`^\\d+$`的正则要求。系统会成功解析并选择对应的关卡。

### 常见错误示例
- **错误输入**：`0`
  - **问题**：虽然`0`是数字，但在游戏逻辑中可能不存在第0关，导致点击坐标计算错误或任务失败。
  - **建议**：确保输入值在有效关卡范围内（1-20）。
- **错误输入**：`1.5` 或 `一`
  - **问题**：`1.5`包含小数点，`一`是中文字符，均不满足`^\\d+$`正则（只允许数字）。系统会直接拒绝。
  - **建议**：仅输入阿拉伯数字。
- **错误输入**：`10a` 或 ` 5 `（前后有空格）
  - **问题**：`10a`包含字母，` 5 `包含空格，均被视为非法字符。`ParamAnalyzer`在解析时可能会因格式错误而失败。
  - **建议**：输入纯数字，避免任何额外字符。
- **配置错误**：`pipeline_type`误设为`"int"`
  - **问题**：虽然在此场景下影响不大，但如果`pipeline_override`期望字符串拼接（如`l={关卡}`），明确的`"string"`类型能保证行为一致。
  - **建议**：根据`custom_action_param`的使用场景，谨慎选择`pipeline_type`。

**Section sources**
- [interface.json](file://assets/interface.json#L768-L785)
- [eat_sugar.py](file://agent/customs/special_treat/eat_sugar.py#L65-L118)